from langchain.tools import tool
from services.embeddings.sa_document_embedder import SADocumentEmbedder
from typing import List, Dict


@tool
def find_related_sa_documents(query: str) -> List[Dict]:
    """
    Инструмент для семантического поиска релевантных технических документов в базе знаний продукта.
    
    Этот инструмент использует векторные эмбеддинги для поиска документов, наиболее близких
    по смыслу к запросу пользователя. Он не ограничивается точным совпадением ключевых слов,
    а понимает контекст и семантику запроса.

    Параметры:
        query (str): Текстовый запрос для поиска. Может быть:
            - Прямым вопросом ("Как работает функция X?")
            - Описанием требуемой информации ("Требования к безопасности")
            - Ключевыми словами ("авторизация пользователей")

    Возвращает:
        List[Dict]: Список найденных документов, где каждый документ содержит:
            - 'content': str - Текстовое содержание найденного фрагмента
            - 'source': str - Название исходного документа
            - 'similarity': float - Оценка релевантности (0.0 до 1.0)

    Использование:
        1. Используйте для поиска конкретной информации в документации
        2. Цитируйте найденные фрагменты в ответах
        3. Опирайтесь на оценку релевантности при выборе цитат

    Примеры запросов:
        - "Требования к авторизации пользователей"
        - "Процесс обработки платежей"
        - "Интеграция с внешними системами"

    Ограничения:
        - Возвращает максимум 5 наиболее релевантных документов
        - Учитывает только текстовую информацию
        - При отсутствии релевантных документов возвращает пустой список
    """

    print(f'bot requested find_related_sa_docs with query {query}')

    document_embedder = SADocumentEmbedder()
    return document_embedder.find_similar_sa_documents(query)